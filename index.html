<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catatan Keuangan</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    padding: 15px;
    display: flex;
    justify-content: center;
}
.container {
    width: 100%;
    max-width: 650px;
}
h2 { text-align: center; }

input, select, button {
    width: 100%;
    padding: 12px;
    margin: 6px 0;
    font-size: 16px;
    box-sizing: border-box;
}

button {
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

table {
    width: 100%;
    margin-top: 10px;
    border-collapse: collapse;
    background: white;
}
th, td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
    text-align: center;
    font-size: 14px;
}
th {
    background: #4CAF50;
    color: white;
}
.aksi button {
    width: auto;
    padding: 5px 8px;
    margin: 0 2px;
    font-size: 12px;
}
.hapus { background: #e74c3c; }
.total {
    margin-top: 10px;
    font-weight: bold;
    text-align: center;
    font-size: 18px;
}
</style>
</head>
<body>

<div class="container">
<h2>Catatan Keuangan</h2>

<select id="user">
    <option value="">Pilih User</option>
    <option>Iqbal</option>
    <option>Gita</option>
</select>

<input type="date" id="tanggal">

<select id="kategori" onchange="updateJenis()">
    <option value="">Pilih Kategori</option>
    <option>Uang Masuk</option>
    <option>Uang Keluar</option>
</select>

<select id="jenis">
    <option value="">Pilih Jenis Transaksi</option>
</select>

<input type="number" id="jumlah" placeholder="Jumlah (Rp)">
<input type="text" id="keterangan" placeholder="Keterangan">

<button onclick="tambah()" id="btnSimpan">Tambah</button>

<table>
<thead>
<tr>
    <th>User</th>
    <th>Tgl</th>
    <th>Kategori</th>
    <th>Jenis</th>
    <th>Nominal</th>
    <th>Keterangan</th>
    <th>Aksi</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<div class="total" id="total">Saldo: Rp 0</div>
</div>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyBfCF6tLybiWd-WQSfVl1iTpKEc2Qnqq5iMDqamkLuODLHlmq44yJeZvLF-frqfJ0YvA/exec"; // ganti dengan URL /exec terbaru

let data = JSON.parse(localStorage.getItem("data")) || [];
let editIndex = -1;

function kirimKeSpreadsheet(obj) {
  const formData = new FormData();
  formData.append("user", obj.user);
  formData.append("tgl", obj.tgl);
  formData.append("kategori", obj.kat);
  formData.append("jenis", obj.jenis);
  formData.append("jumlah", obj.jml);
  formData.append("keterangan", obj.ket);

  fetch(URL_SCRIPT, {
    method: "POST",
    body: formData
  })
  .then(res => res.text())
  .then(res => console.log("Terkirim ke spreadsheet:", res))
  .catch(err => console.error("Gagal kirim:", err));
}

function updateJenis(selectedValue = "") {
    const kategori = document.getElementById("kategori").value;
    const jenisSelect = document.getElementById("jenis");
    jenisSelect.innerHTML = '<option value="">Pilih Jenis Transaksi</option>';

    let opsi = [];
    if (kategori === "Uang Masuk") {
        opsi = ["Gaji", "Other"];
    } else if (kategori === "Uang Keluar") {
        opsi = ["Jajan","Dapur","Tagihan","Anak","Orang Tua",
                "Transport","Kebutuhan & Hiburan","Nabung","Other"];
    }

    opsi.forEach(teks => {
        let opt = document.createElement("option");
        opt.value = teks;
        opt.textContent = teks;
        if (teks === selectedValue) opt.selected = true;
        jenisSelect.appendChild(opt);
    });
}

function render() {
    let list = document.getElementById("list");
    list.innerHTML = "";
    let saldo = 0;

    data.forEach((d, i) => {
        let row = document.createElement("tr");
        row.innerHTML = `
            <td>${d.user}</td>
            <td>${d.tgl}</td>
            <td>${d.kat}</td>
            <td>${d.jenis}</td>
            <td>${d.jml.toLocaleString("id-ID")}</td>
            <td>${d.ket}</td>
            <td class="aksi">
                <button onclick="editData(${i})">Edit</button>
                <button class="hapus" onclick="hapusData(${i})">Hapus</button>
            </td>
        `;
        list.appendChild(row);

        if (d.kat === "Uang Masuk") saldo += d.jml;
        else saldo -= d.jml;
    });

    document.getElementById("total").innerText =
        "Saldo: Rp " + saldo.toLocaleString("id-ID");
}

function tambah() {
    let usr = user.value;
    let tgl = tanggal.value;
    let kat = kategori.value;
    let jns = jenis.value;
    let jml = parseInt(jumlah.value);
    let ket = keterangan.value;

    if (!usr || !tgl || !kat || !jns || !jml || !ket) {
        alert("Lengkapi data!");
        return;
    }

    let obj = { user: usr, tgl, kat, jenis: jns, jml, ket };

    kirimKeSpreadsheet(obj); // kirim ke Google Sheet

    if (editIndex === -1) {
        data.push(obj);
    } else {
        data[editIndex] = obj;
        editIndex = -1;
        btnSimpan.innerText = "Tambah";
    }

    localStorage.setItem("data", JSON.stringify(data));
    render();
    resetForm();
}

function editData(i) {
    let d = data[i];
    editIndex = i;

    user.value = d.user;
    tanggal.value = d.tgl;
    kategori.value = d.kat;
    updateJenis(d.jenis);
    jumlah.value = d.jml;
    keterangan.value = d.ket;

    btnSimpan.innerText = "Simpan Perubahan";
}

function hapusData(i) {
    if (confirm("Hapus transaksi ini?")) {
        data.splice(i, 1);
        localStorage.setItem("data", JSON.stringify(data));
        render();
        resetForm();
    }
}

function resetForm() {
    user.value = "";
    tanggal.value = "";
    kategori.value = "";
    jenis.innerHTML = '<option value="">Pilih Jenis Transaksi</option>';
    jumlah.value = "";
    keterangan.value = "";
    editIndex = -1;
    btnSimpan.innerText = "Tambah";
}

render();
</script>
</body>
</html>
