<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Catatan Keuangan</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
.container{max-width:900px;margin:auto}
h2{text-align:center}
input,select,button{width:100%;padding:8px;margin:5px 0}
button{background:#4CAF50;color:#fff;border:0;border-radius:6px}
button.secondary{background:#777}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{padding:6px;border-bottom:1px solid #ddd;font-size:13px;text-align:center}
th{background:#4CAF50;color:#fff}
.filter{background:#fff;padding:10px;border-radius:8px;margin-bottom:10px}
.hidden{display:none}
.notif{display:none;background:#4CAF50;color:#fff;padding:8px;text-align:center}
</style>
</head>

<body>
<div class="container">

<h2>Catatan Keuangan</h2>
<div class="notif" id="notif">‚úÖ Berhasil</div>

<button class="secondary" onclick="filterBox.classList.toggle('hidden')">üîç Filter</button>

<div class="filter hidden" id="filterBox">
  <select id="fUser" onchange="loadData()">
    <option value="">Semua User</option>
    <option>Iqbal</option>
    <option>Gita</option>
  </select>
</div>

<select id="user"><option>Iqbal</option><option>Gita</option></select>
<input type="date" id="tanggal">

<select id="kategori" onchange="updateJenis()">
<option value="">Kategori</option>
<option>Uang Masuk</option>
<option>Uang Keluar</option>
</select>

<select id="jenis"></select>
<input id="jumlah" placeholder="Nominal">
<input id="keterangan" placeholder="Keterangan">

<button onclick="simpan()">üíæ Simpan</button>

<table>
<thead>
<tr>
<th>User</th><th>Tgl</th><th>Kat</th><th>Jenis</th><th>Rp</th><th>Ket</th><th>Aksi</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<div id="total"></div>
<canvas id="chart" height="200"></canvas>

</div>

<script>
const URL_SCRIPT="https://script.google.com/macros/s/AKfycbyh0JwT1QXYqMx7r1tgK9xPo81T24SB3JvHns2pn3xCVxHCTmWs2fVnz1cWhrCNlw8PEA/exec";

let editId=null, chart;

/* JENIS */
function updateJenis(){
  jenis.innerHTML="";
  (kategori.value==="Uang Masuk"
    ?["Gaji","Other"]
    :["Jajan","Tagihan","Transport","Other"]
  ).forEach(v=>{
    let o=document.createElement("option");
    o.value=o.text=v;
    jenis.appendChild(o);
  });
}

/* SIMPAN / UPDATE */
function simpan(){
  let fd=new FormData();
  fd.append("user",user.value);
  fd.append("tanggal",tanggal.value);
  fd.append("kategori",kategori.value);
  fd.append("jenis",jenis.value);
  fd.append("jumlah",jumlah.value);
  fd.append("keterangan",keterangan.value);

  let url = URL_SCRIPT;
  if(editId){
    fd.append("id",editId);
    url += "?action=update";
  }

  fetch(url,{method:"POST",body:fd})
    .then(r=>r.json())
    .then(()=>{
      editId=null;
      notif.style.display="block";
      setTimeout(()=>notif.style.display="none",1500);
      loadData();
    });
}

/* LOAD DATA */
function loadData(){
 fetch(URL_SCRIPT+"?user="+fUser.value)
 .then(r=>r.json())
 .then(showData);
}

/* EDIT */
function edit(d){
 editId=d.id;
 user.value=d.user;
 tanggal.value=d.tanggal;
 kategori.value=d.kategori;
 updateJenis();
 jenis.value=d.jenis;
 jumlah.value=d.jumlah;
 keterangan.value=d.keterangan;
}

/* DELETE */
function hapus(id){
 if(confirm("Hapus data?")){
   fetch(URL_SCRIPT+"?action=delete&id="+id)
   .then(r=>r.json())
   .then(loadData);
 }
}

/* TAMPIL + CHART */
function showData(rows){
 list.innerHTML="";
 let saldo=0,map={};

 rows.forEach(d=>{
  saldo+=d.kategori==="Uang Masuk"?+d.jumlah:-d.jumlah;
  let m=d.tanggal?.substr(0,7);
  if(m) map[m]=(map[m]||0)+(d.kategori==="Uang Masuk"?+d.jumlah:-d.jumlah);

  list.innerHTML+=`
   <tr>
    <td>${d.user}</td>
    <td>${new Date(d.tanggal).toLocaleDateString("id-ID")}</td>
    <td>${d.kategori}</td>
    <td>${d.jenis}</td>
    <td>${Number(d.jumlah).toLocaleString("id-ID")}</td>
    <td>${d.keterangan||""}</td>
    <td>
      <button onclick='edit(${JSON.stringify(d)})'>‚úè</button>
      <button onclick="hapus('${d.id}')">üóë</button>
    </td>
   </tr>`;
 });

 total.innerText="Saldo: Rp "+saldo.toLocaleString("id-ID");

 if(chart)chart.destroy();
 chart=new Chart(document.getElementById("chart"),{
  type:"bar",
  data:{labels:Object.keys(map),datasets:[{label:"Saldo Bulanan",data:Object.values(map)}]}
 });
}

loadData();
</script>
</body>
</html>
