<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Keuangan</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f2f2f2;
            padding: 10px;
            margin: 0;
        }

        .container {
            max-width: 900px;
            margin: auto;
        }

        h2 {
            text-align: center;
            margin-bottom: 10px;
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            font-size: 14px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        button.secondary {
            background: #777;
        }

        .filter {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .filter.hidden {
            display: none;
        }

        .table-wrap {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 6px;
            border-bottom: 1px solid #ddd;
            text-align: center;
            font-size: 13px;
        }

        th {
            background: #4CAF50;
            color: white;
        }

        .total {
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
        }

        .notif {
            display: none;
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 10px;
        }

        /* RESPONSIVE */
        @media (max-width: 600px) {
            th, td {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Catatan Keuangan</h2>
        <div class="notif" id="notif">‚úÖ Data berhasil disimpan</div>
        <button class="secondary" onclick="toggleFilter()">üîç Tampilkan / Sembunyikan Filter</button>

        <!-- FILTER -->
        <div class="filter hidden" id="filterBox">
            <select id="fUser">
                <option value="">Semua User</option>
                <option>Iqbal</option>
                <option>Gita</option>
            </select>
            <select id="fKategori">
                <option value="">Semua Kategori</option>
                <option>Uang Masuk</option>
                <option>Uang Keluar</option>
            </select>
            <input type="date" id="fFrom">
            <input type="date" id="fTo">
            <button onclick="loadData()">Terapkan Filter</button>
        </div>

        <!-- INPUT -->
        <select id="user">
            <option value="">Pilih User</option>
            <option>Iqbal</option>
            <option>Gita</option>
        </select>
        <input type="date" id="tanggal">
        <select id="kategori" onchange="updateJenis()">
            <option value="">Pilih Kategori</option>
            <option>Uang Masuk</option>
            <option>Uang Keluar</option>
        </select>
        <select id="jenis">
            <option value="">Pilih Jenis</option>
        </select>
        <input type="text" id="jumlah" placeholder="Nominal (Rp)" oninput="formatRupiah(this)">
        <input type="text" id="keterangan" placeholder="Keterangan">
        <button onclick="simpan()">üíæ Simpan</button>

        <div style="display:flex;justify-content:flex-end">
            <select id="limit" style="width:120px" onchange="loadData()">
                <option value="10">10 Data</option>
                <option value="25">25 Data</option>
                <option value="50">50 Data</option>
                <option value="100">100 Data</option>
            </select>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Tgl</th>
                        <th>Kategori</th>
                        <th>Jenis</th>
                        <th>Nominal</th>
                        <th>Keterangan</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="list"></tbody>
            </table>
        </div>

        <div class="total" id="total">Saldo: Rp 0</div>
    </div>

    <canvas id="chart" height="200"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyh0JwT1QXYqMx7r1tgK9xPo81T24SB3JvHns2pn3xCVxHCTmWs2fVnz1cWhrCNlw8PEA/exec";
        let editingId = null;

        /* FILTER TOGGLE */
        function toggleFilter() {
            filterBox.classList.toggle("hidden");
        }

        /* FORMAT RUPIAH */
        function formatRupiah(el) {
            let angka = el.value.replace(/\D/g, "");
            el.value = angka.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        /* FORMAT TANGGAL */
        function formatTanggal(tgl) {
            const d = new Date(tgl);
            return d.toLocaleDateString("id-ID");
        }

        /* JENIS */
        function updateJenis() {
            const j = jenis;
            j.innerHTML = "<option value=''>Pilih Jenis</option>";
            const data = kategori.value === "Uang Masuk" ? ["Gaji", "Other"] : ["Jajan", "Dapur", "Tagihan", "Anak", "Transport", "Hiburan", "Nabung", "Other"];
            data.forEach(v => {
                let o = document.createElement("option");
                o.text = o.value = v;
                j.add(o);
            });
        }

        /* SIMPAN / UPDATE */
        function simpan() {
            let nominal = jumlah.value.replace(/\D/g, "");
            if (!user.value || !tanggal.value || !kategori.value || !jenis.value || !nominal) {
                alert("Lengkapi data!");
                return;
            }
            let data = {
                user: user.value,
                tanggal: tanggal.value,
                kategori: kategori.value,
                jenis: jenis.value,
                jumlah: nominal,
                keterangan: keterangan.value
            };
            if (editingId) data.id = editingId;
            fetch(URL_SCRIPT, { method: "POST", body: JSON.stringify(data), headers: { 'Content-Type': 'application/json' } })
                .then(r => r.text())
                .then(() => {
                    notif.style.display = "block";
                    setTimeout(() => notif.style.display = "none", 2000);
                    resetForm();
                    loadData();
                });
        }

        function resetForm() {
            user.value = "";
            tanggal.value = "";
            kategori.value = "";
            jenis.innerHTML = "<option value=''>Pilih Jenis</option>";
            jumlah.value = "";
            keterangan.value = "";
            editingId = null;
            document.querySelector('button[onclick="simpan()"]').innerText = 'üíæ Simpan';
        }

        /* EDIT DATA */
        function editData(id, userVal, tanggalVal, kategoriVal, jenisVal, jumlahVal, keteranganVal) {
            editingId = id;
            user.value = userVal;
            tanggal.value = tanggalVal;
            kategori.value = kategoriVal;
            updateJenis();
            jenis.value = jenisVal;
            jumlah.value = jumlahVal.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            keterangan.value = keteranganVal;
            document.querySelector('button[onclick="simpan()"]').innerText = 'üîÑ Update';
        }

        /* LOAD DATA */
        function loadData() {
            let url = URL_SCRIPT + "?action=get" + "&user=" + fUser.value + "&kategori=" + fKategori.value + "&from=" + fFrom.value + "&to=" + fTo.value + "&limit=" + limit.value;
            fetch(url).then(r => r.json()).then(showData);
        }

        /* HAPUS DATA */
        function hapus(id) {
            if (!confirm("Hapus data ini?")) return;
            fetch(URL_SCRIPT + "?action=delete&id=" + id)
                .then(() => loadData());
        }

        /* GRAFIK BULANAN OTOMATIS */
        let chart;
        const chartCanvas = document.getElementById('chart');
        function renderChart(rows) {
            let map = {};
            rows.forEach(d => {
                if (d.tanggal) {
                    let bulan = d.tanggal.substr(0, 7);
                    map[bulan] = (map[bulan] || 0) + (d.kategori === "Uang Masuk" ? +d.jumlah : -d.jumlah);
                }
            });
            let labels = Object.keys(map);
            let data = Object.values(map);
            if (chart) chart.destroy();
            chart = new Chart(chartCanvas, {
                type: "bar",
                data: { labels, datasets: [{ label: "Saldo", data }] }
            });
        }

        function showData(rows) {
            list.innerHTML = "";
            let saldo = 0;
            renderChart(rows);
            rows.forEach(d => {
                let tr = document.createElement("tr");
                tr.innerHTML = `<td>${d.user}</td>
                                <td>${formatTanggal(d.tanggal)}</td>
                                <td>${d.kategori}</td>
                                <td>${d.jenis}</td>
                                <td>${Number(d.jumlah).toLocaleString("id-ID")}</td>
                                <td>${d.keterangan}</td>
                                <td>
                                    <button onclick="editData('${d.id}', '${d.user}', '${d.tanggal}', '${d.kategori}', '${d.jenis}', '${d.jumlah}', '${d.keterangan}')">‚úè</button>
                                    <button onclick="hapus('${d.id}')">üóë</button>
                                </td>`;
                list.appendChild(tr);
                saldo += d.kategori === "Uang Masuk" ? +d.jumlah : -d.jumlah;
            });
            total.innerText = "Saldo: Rp " + saldo.toLocaleString("id-ID");
        }

        loadData();
    </script>
</body>
</html>
