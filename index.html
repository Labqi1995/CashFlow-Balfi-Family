<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catatan Keuangan</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
.container{max-width:900px;margin:auto}
input,select,button{width:100%;padding:10px;margin:5px 0}
button{background:#4CAF50;color:#fff;border:none;border-radius:6px}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:center}
th{background:#4CAF50;color:#fff}
.table-wrap{overflow-x:auto}
.total{font-size:18px;font-weight:bold;text-align:center;margin-top:10px}
</style>
</head>
<body>

<div class="container">
<h2>Catatan Keuangan</h2>

<select id="user">
  <option value="">Pilih User</option>
  <option>Iqbal</option>
  <option>Gita</option>
</select>

<input type="date" id="tanggal">

<select id="kategori" onchange="updateJenis()">
  <option value="">Kategori</option>
  <option>Uang Masuk</option>
  <option>Uang Keluar</option>
</select>

<select id="jenis"></select>

<input type="text" id="jumlah" placeholder="Nominal" oninput="formatRupiah(this)">
<input type="text" id="keterangan" placeholder="Keterangan">

<button onclick="simpan()">üíæ Simpan</button>

<select id="limit" onchange="loadData()" style="width:120px;float:right">
  <option>10</option><option>25</option><option>50</option>
</select>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>User</th><th>Tgl</th><th>Kat</th><th>Jenis</th>
<th>Nominal</th><th>Ket</th><th>Aksi</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<div class="total" id="total"></div>
<canvas id="chart" height="200"></canvas>
</div>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyh0JwT1QXYqMx7r1tgK9xPo81T24SB3JvHns2pn3xCVxHCTmWs2fVnz1cWhrCNlw8PEA/exec";
let editId = null;
const chartCanvas = document.getElementById("chart");
let chart;

function formatRupiah(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/\B(?=(\d{3})+(?!\d))/g,".");
}

function updateJenis(){
  jenis.innerHTML="";
  let data = kategori.value==="Uang Masuk"
    ? ["Gaji","Other"]
    : ["Jajan","Dapur","Transport","Tagihan","Other"];
  data.forEach(v=>{
    let o=document.createElement("option");
    o.text=o.value=v;
    jenis.add(o);
  });
}

function simpan(){
  let fd=new FormData();
  fd.append("user",user.value);
  fd.append("tanggal",tanggal.value);
  fd.append("kategori",kategori.value);
  fd.append("jenis",jenis.value);
  fd.append("jumlah",jumlah.value.replace(/\D/g,""));
  fd.append("keterangan",keterangan.value);

  if(editId){
    fd.append("action","update");
    fd.append("id",editId);
  }

  fetch(URL_SCRIPT,{method:"POST",body:fd})
    .then(()=>{ editId=null; loadData(); });
}

function hapus(id){
  if(!confirm("Hapus data?"))return;
  fetch(URL_SCRIPT,{method:"POST",body:new URLSearchParams({action:"delete",id})})
    .then(()=>loadData());
}

function edit(d){
  editId=d.id;
  user.value=d.user;
  tanggal.value=d.tanggal;
  kategori.value=d.kategori;
  updateJenis();
  jenis.value=d.jenis;
  jumlah.value=Number(d.jumlah).toLocaleString("id-ID");
  keterangan.value=d.keterangan;
}

function loadData(){
  fetch(URL_SCRIPT+"?limit="+limit.value)
    .then(r=>r.json())
    .then(showData);
}

function showData(rows){
  list.innerHTML="";
  let saldo=0;
  let map={};

  rows.forEach(d=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${d.user}</td>
      <td>${new Date(d.tanggal).toLocaleDateString("id-ID")}</td>
      <td>${d.kategori}</td>
      <td>${d.jenis}</td>
      <td>${Number(d.jumlah).toLocaleString("id-ID")}</td>
      <td>${d.keterangan}</td>
      <td>
        <button onclick='edit(${JSON.stringify(d)})'>‚úè</button>
        <button onclick='hapus("${d.id}")'>üóë</button>
      </td>`;
    list.appendChild(tr);

    saldo += d.kategori==="Uang Masuk"?+d.jumlah:-d.jumlah;

    let bulan=d.tanggal.substr(0,7);
    map[bulan]=(map[bulan]||0)+(d.kategori==="Uang Masuk"?+d.jumlah:-d.jumlah);
  });

  total.innerText="Saldo: Rp "+saldo.toLocaleString("id-ID");

  if(chart)chart.destroy();
  chart=new Chart(chartCanvas,{
    type:"bar",
    data:{labels:Object.keys(map),datasets:[{label:"Saldo Bulanan",data:Object.values(map)}]}
  });
}

loadData();
</script>
</body>
</html>
