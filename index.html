<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Catatan Keuangan</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
.container{max-width:900px;margin:auto}
h2{text-align:center}
input,select,button{width:100%;padding:8px;margin:5px 0}
button{background:#4CAF50;color:#fff;border:0;border-radius:6px}
button.secondary{background:#777}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{padding:6px;border-bottom:1px solid #ddd;font-size:13px;text-align:center}
th{background:#4CAF50;color:#fff}
.filter{background:#fff;padding:10px;border-radius:8px;margin-bottom:10px}
.hidden{display:none}
.notif{display:none;background:#4CAF50;color:#fff;padding:8px;text-align:center}
</style>
</head>

<body>
<div class="container">

<h2>Catatan Keuangan</h2>
<div class="notif" id="notif">‚úÖ Berhasil</div>

<button class="secondary" onclick="filterBox.classList.toggle('hidden')">üîç Filter</button>

<div class="filter hidden" id="filterBox">
  <select id="fUser" onchange="loadData()">
    <option value="">Semua User</option>
    <option>Iqbal</option>
    <option>Gita</option>
  </select>
</div>

<select id="user"><option>Iqbal</option><option>Gita</option></select>
<input type="date" id="tanggal">

<select id="kategori" onchange="updateJenis()">
<option value="">Kategori</option>
<option>Uang Masuk</option>
<option>Uang Keluar</option>
</select>

<select id="jenis"></select>
<input id="jumlah" placeholder="Nominal">
<input id="keterangan" placeholder="Keterangan">

<button onclick="simpan()">üíæ Simpan</button>

<table>
<thead>
<tr>
<th>User</th><th>Tgl</th><th>Kat</th><th>Jenis</th><th>Rp</th><th>Ket</th><th>Aksi</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<div id="total"></div>
<canvas id="chart" height="200"></canvas>

</div>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyh0JwT1QXYqMx7r1tgK9xPo81T24SB3JvHns2pn3xCVxHCTmWs2fVnz1cWhrCNlw8PEA/exec";

let editId = null;
let chart = null;

// Safe JSON fetch (tolerant if backend returns text)
async function safeFetchJSON(url) {
  try {
    const res = await fetch(url);
    const text = await res.text();
    try {
      return JSON.parse(text);
    } catch(e) {
      console.warn("safeFetchJSON: not valid JSON, returning empty array", text);
      return [];
    }
  } catch(err) {
    console.error("safeFetchJSON fetch error:", err);
    return [];
  }
}

function updateJenis(){
  jenis.innerHTML = '<option value="">Pilih Jenis</option>';
  const data = kategori.value==="Uang Masuk"
    ? ["Gaji","Other"]
    : ["Jajan","Dapur","Tagihan","Anak","Transport","Hiburan","Nabung","Other"];
  data.forEach(v => {
    let o = document.createElement("option");
    o.value = o.text = v;
    jenis.appendChild(o);
  });
}

function simpan(){
  let nominal = jumlah.value.replace(/\D/g,"");
  if (!user.value || !tanggal.value || !kategori.value || !jenis.value || !nominal) {
    alert("Lengkapi data!");
    return;
  }
  let fd = new FormData();
  fd.append("user", user.value);
  fd.append("tanggal", tanggal.value);
  fd.append("kategori", kategori.value);
  fd.append("jenis", jenis.value);
  fd.append("jumlah", nominal);
  fd.append("keterangan", keterangan.value);

  let url = URL_SCRIPT;
  if (editId) {
    fd.append("id", editId);
    url += "?action=update";
  }

  fetch(url, { method: "POST", body: fd })
    .then(res => res.text())
    .then(txt => {
      console.log("Response on save:", txt);
      notif.style.display = "block";
      setTimeout(() => notif.style.display = "none", 2000);
      editId = null;
      loadData();
    });
}

async function loadData(){
  const url = URL_SCRIPT +
    "?user=" + encodeURIComponent(fUser.value) +
    "&kategori=" + encodeURIComponent(fKategori.value) +
    "&from=" + encodeURIComponent(fFrom.value) +
    "&to=" + encodeURIComponent(fTo.value) +
    "&limit=" + encodeURIComponent(limit.value);
  
  const rows = await safeFetchJSON(url);
  showData(Array.isArray(rows) ? rows : []);
}

function edit(d){
  editId = d.id;
  user.value = d.user;
  tanggal.value = d.tanggal;
  kategori.value = d.kategori;
  updateJenis();
  jenis.value = d.jenis;
  jumlah.value = Number(d.jumlah).toLocaleString("id-ID");
  keterangan.value = d.keterangan;
}

function hapus(id){
  if (!confirm("Hapus data ini?")) return;

  const fd = new FormData();
  fd.append("action", "delete");
  fd.append("id", id);

  fetch(URL_SCRIPT, { method: "POST", body: fd })
    .then(res => res.text())
    .then(txt => {
      console.log("Response on delete:", txt);
      loadData();
    });
}

function showData(rows){
  console.table(rows);
  list.innerHTML = "";
  let saldo = 0;
  let map = {};

  rows.forEach(d => {
    saldo += (d.kategori === "Uang Masuk" ? +d.jumlah : -d.jumlah);
    const month = (d.tanggal || "").substr(0,7);
    if(month) map[month] = (map[month] || 0) + (d.kategori === "Uang Masuk" ? +d.jumlah : -d.jumlah);

    list.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${d.user || ""}</td>
        <td>${d.tanggal ? new Date(d.tanggal).toLocaleDateString("id-ID") : ""}</td>
        <td>${d.kategori || ""}</td>
        <td>${d.jenis || ""}</td>
        <td>${Number(d.jumlah || 0).toLocaleString("id-ID")}</td>
        <td>${d.keterangan || ""}</td>
        <td>
          <button onclick='edit(${JSON.stringify(d)})'>‚úè</button>
          <button onclick="hapus('${d.id}')">üóë</button>
        </td>
      </tr>
    `);
  });

  total.innerText = "Saldo: Rp " + saldo.toLocaleString("id-ID");

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "bar",
    data: {
      labels: Object.keys(map),
      datasets: [{ label: "Saldo Bulanan", data: Object.values(map) }]
    }
  });
}

// load first time
loadData();
</script>
