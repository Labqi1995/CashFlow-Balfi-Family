<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catatan Keuangan</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    padding: 15px;
    display: flex;
    justify-content: center;
}
.container {
    width: 100%;
    max-width: 700px;
}
h2 { text-align: center; }

input, select, button {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    font-size: 14px;
}

button {
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

table {
    width: 100%;
    margin-top: 10px;
    border-collapse: collapse;
    background: white;
}
th, td {
    padding: 6px;
    border-bottom: 1px solid #ddd;
    text-align: center;
    font-size: 13px;
}
th {
    background: #4CAF50;
    color: white;
}

.filter {
    background: #fff;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
}

.total {
    margin-top: 10px;
    font-weight: bold;
    text-align: center;
    font-size: 18px;
}
</style>
</head>
<body>

<div class="container">
<h2>Catatan Keuangan</h2>

<!-- FILTER -->
<div class="filter">
<select id="fUser">
    <option value="">Semua User</option>
    <option>Iqbal</option>
    <option>Gita</option>
</select>

<select id="fKategori">
    <option value="">Semua Kategori</option>
    <option>Uang Masuk</option>
    <option>Uang Keluar</option>
</select>

<input type="date" id="fTanggal">
<button onclick="loadData()">Filter</button>
</div>

<!-- INPUT -->
<select id="user">
    <option value="">Pilih User</option>
    <option>Iqbal</option>
    <option>Gita</option>
</select>

<input type="date" id="tanggal">

<select id="kategori" onchange="updateJenis()">
    <option value="">Pilih Kategori</option>
    <option>Uang Masuk</option>
    <option>Uang Keluar</option>
</select>

<select id="jenis">
    <option value="">Pilih Jenis</option>
</select>

<input type="text" id="jumlah" placeholder="Nominal (Rp)" oninput="formatRupiah(this)">
<input type="text" id="keterangan" placeholder="Keterangan">

<button onclick="simpan()">Simpan</button>

<table>
<thead>
<tr>
    <th>User</th>
    <th>Tgl</th>
    <th>Kategori</th>
    <th>Jenis</th>
    <th>Nominal</th>
    <th>Keterangan</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<div class="total" id="total">Saldo: Rp 0</div>
</div>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbxCAmxysuBBQwyUc88tKtwmLsIdWLMzjRTqm2zx53kCgP0izunEC5JfksKgolgG0K0NPg/exec";

/* ================== FORMAT RUPIAH ================== */
function formatRupiah(el) {
    let angka = el.value.replace(/\D/g, "");
    el.value = angka.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

/* ================== JENIS ================== */
function updateJenis() {
    const kategori = document.getElementById("kategori").value;
    const jenis = document.getElementById("jenis");
    jenis.innerHTML = "<option value=''>Pilih Jenis</option>";

    let data = kategori === "Uang Masuk"
        ? ["Gaji", "Other"]
        : ["Jajan","Dapur","Tagihan","Anak","Orang Tua","Transport","Hiburan","Nabung","Other"];

    data.forEach(v => {
        let o = document.createElement("option");
        o.text = o.value = v;
        jenis.add(o);
    });
}

/* ================== SIMPAN ================== */
function simpan() {
    let nominal = jumlah.value.replace(/\D/g,"");

    if (!user.value || !tanggal.value || !kategori.value || !jenis.value || !nominal) {
        alert("Lengkapi data!");
        return;
    }

    let fd = new FormData();
    fd.append("user", user.value);
    fd.append("tanggal", tanggal.value);
    fd.append("kategori", kategori.value);
    fd.append("jenis", jenis.value);
    fd.append("jumlah", nominal);
    fd.append("keterangan", keterangan.value);

    fetch(URL_SCRIPT, { method:"POST", body: fd })
        .then(r => r.text())
        .then(() => {
            resetForm();
            loadData();
        });
}

function resetForm(){
    user.value="";
    tanggal.value="";
    kategori.value="";
    jenis.innerHTML="<option value=''>Pilih Jenis</option>";
    jumlah.value="";
    keterangan.value="";
}

/* ================== LOAD DATA ================== */
function loadData() {
    let url = URL_SCRIPT + "?action=read"
        + "&user=" + fUser.value
        + "&kategori=" + fKategori.value
        + "&tanggal=" + fTanggal.value;

    fetch(url)
        .then(r => r.json())
        .then(showData);
}

function showData(rows){
    let list = document.getElementById("list");
    list.innerHTML="";
    let saldo = 0;

    rows.forEach(d=>{
        let tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${d.user}</td>
            <td>${d.tanggal}</td>
            <td>${d.kategori}</td>
            <td>${d.jenis}</td>
            <td>${Number(d.jumlah).toLocaleString("id-ID")}</td>
            <td>${d.keterangan}</td>
        `;
        list.appendChild(tr);

        saldo += d.kategori==="Uang Masuk" ? +d.jumlah : -d.jumlah;
    });

    total.innerText = "Saldo: Rp " + saldo.toLocaleString("id-ID");
}

loadData();
</script>
</body>
</html>
